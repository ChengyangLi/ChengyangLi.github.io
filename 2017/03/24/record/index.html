<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Audio -- PCM to AAC | _小__东邪___</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文需求：将Mic采集的PCM转成AAC，可得到两种不同数据,本例采用AudioQueue存储由于公司需求更改为Mic采集的pcm一路提供给WebRTC使用，另一路将pcm转为aac，将aac提供给直播用的API。因此应该先让Mic采集原始pcm数据，采用队列保存，然后在回调函数中将其转换为aac提供给C++API,github地址:原文代码">
<meta property="og:type" content="article">
<meta property="og:title" content="Audio -- PCM to AAC">
<meta property="og:url" content="http://yoursite.com/2017/03/24/record/index.html">
<meta property="og:site_name" content="_小__东邪___">
<meta property="og:description" content="本文需求：将Mic采集的PCM转成AAC，可得到两种不同数据,本例采用AudioQueue存储由于公司需求更改为Mic采集的pcm一路提供给WebRTC使用，另一路将pcm转为aac，将aac提供给直播用的API。因此应该先让Mic采集原始pcm数据，采用队列保存，然后在回调函数中将其转换为aac提供给C++API,github地址:原文代码">
<meta property="og:image" content="http://yoursite.com/img/record/1.png">
<meta property="og:updated_time" content="2017-03-24T09:53:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Audio -- PCM to AAC">
<meta name="twitter:description" content="本文需求：将Mic采集的PCM转成AAC，可得到两种不同数据,本例采用AudioQueue存储由于公司需求更改为Mic采集的pcm一路提供给WebRTC使用，另一路将pcm转为aac，将aac提供给直播用的API。因此应该先让Mic采集原始pcm数据，采用队列保存，然后在回调函数中将其转换为aac提供给C++API,github地址:原文代码">
<meta name="twitter:image" content="http://yoursite.com/img/record/1.png">
  
    <link rel="alternative" href="/atom.xml" title="_小__东邪___" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/head.png" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/">小东邪_Chengyang</a></h1>
        </hgroup>

        
        <p class="header-subtitle">风陵渡口初相遇,一遇杨过误终身.</p>
        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">桃花岛</a></li>
                        
                            <li><a href="/works">绝世武功</a></li>
                        
                            <li><a href="/about">千里传音</a></li>
                        
                            <li><a href="/FrontEndGuide">黯然销魂</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl mail" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=xiao_dx@foxmail.com" title="mail">mail</a>
                            
                                <a class="fl github" target="_blank" href="https://github.com/ChengyangLi/ChengyangLi.github.io" title="github">github</a>
                            
                                <a class="fl zhihu" target="_blank" href="https://www.zhihu.com/people/xiao-dong-xie-75" title="zhihu">zhihu</a>
                            
                                <a class="fl weibo" target="_blank" href="http://weibo.com/u/5088497199" title="weibo">weibo</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/AAC/" style="font-size: 10px;">AAC</a> <a href="/tags/Apache/" style="font-size: 10px;">Apache</a> <a href="/tags/Audio/" style="font-size: 10px;">Audio</a> <a href="/tags/Masonry/" style="font-size: 10px;">Masonry</a> <a href="/tags/MyEclipse/" style="font-size: 10px;">MyEclipse</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/PCM/" style="font-size: 10px;">PCM</a> <a href="/tags/TableViewGroup/" style="font-size: 10px;">TableViewGroup</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/iOS-API/" style="font-size: 10px;">iOS API</a> <a href="/tags/ios/" style="font-size: 20px;">ios</a> <a href="/tags/传值/" style="font-size: 10px;">传值</a> <a href="/tags/富文本/" style="font-size: 10px;">富文本</a> <a href="/tags/小东邪/" style="font-size: 10px;">小东邪</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="/">暂无</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">太原理工初相见,一遇张霞误终身.</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">小东邪_Chengyang</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/head.png" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">小东邪_Chengyang</a></h1>
            </hgroup>
            
            <p class="header-subtitle">风陵渡口初相遇,一遇杨过误终身.</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">桃花岛</a></li>
                
                    <li><a href="/works">绝世武功</a></li>
                
                    <li><a href="/about">千里传音</a></li>
                
                    <li><a href="/FrontEndGuide">黯然销魂</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="mail" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=xiao_dx@foxmail.com" title="mail">mail</a>
                    
                        <a class="github" target="_blank" href="https://github.com/ChengyangLi/ChengyangLi.github.io" title="github">github</a>
                    
                        <a class="zhihu" target="_blank" href="https://www.zhihu.com/people/xiao-dong-xie-75" title="zhihu">zhihu</a>
                    
                        <a class="weibo" target="_blank" href="http://weibo.com/u/5088497199" title="weibo">weibo</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-record" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/24/record/" class="article-date">
      <time datetime="2017-03-24T07:36:31.000Z" itemprop="datePublished">2017-03-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Audio -- PCM to AAC
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AAC/">AAC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Audio/">Audio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PCM/">PCM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><excerpt in="" index="" |="" 首页摘要=""> </excerpt></p>
<ul>
<li>本文需求：将Mic采集的PCM转成AAC，可得到两种不同数据,本例采用AudioQueue存储<br>由于公司需求更改为Mic采集的pcm一路提供给WebRTC使用，另一路将pcm转为aac，将aac提供给直播用的API。因此应该先让Mic采集原始pcm数据，采用队列保存，然后在回调函数中将其转换为aac提供给C++API,github地址:<a href="https://github.com/ChengyangLi/XDXPCMToAACDemo" target="_blank" rel="external">原文代码</a><a id="more"></a>
<the rest="" of="" contents="" |="" 余下全文="">

</the></li>
</ul>
<h3 id="本例需求：将Mic采集的PCM转成AAC，可得到两种不同数据-本例采用AudioQueue存储"><a href="#本例需求：将Mic采集的PCM转成AAC，可得到两种不同数据-本例采用AudioQueue存储" class="headerlink" title="本例需求：将Mic采集的PCM转成AAC，可得到两种不同数据,本例采用AudioQueue存储"></a>本例需求：将Mic采集的PCM转成AAC，可得到两种不同数据,本例采用AudioQueue存储</h3><h3 id="原理：由于需求更改为Mic采集的pcm一路提供给WebRTC使用，另一路将pcm转为aac，将aac提供给直播用的API。因此应该先让Mic采集原始pcm数据，采用队列保存，然后在回调函数中将其转换为aac提供给C-API"><a href="#原理：由于需求更改为Mic采集的pcm一路提供给WebRTC使用，另一路将pcm转为aac，将aac提供给直播用的API。因此应该先让Mic采集原始pcm数据，采用队列保存，然后在回调函数中将其转换为aac提供给C-API" class="headerlink" title="原理：由于需求更改为Mic采集的pcm一路提供给WebRTC使用，另一路将pcm转为aac，将aac提供给直播用的API。因此应该先让Mic采集原始pcm数据，采用队列保存，然后在回调函数中将其转换为aac提供给C++API"></a>原理：由于需求更改为Mic采集的pcm一路提供给WebRTC使用，另一路将pcm转为aac，将aac提供给直播用的API。因此应该先让Mic采集原始pcm数据，采用队列保存，然后在回调函数中将其转换为aac提供给C++API</h3><p><img src="/img/record/1.png" alt="Alt text"></p>
<h2 id="一-本文需要基本知识点"><a href="#一-本文需要基本知识点" class="headerlink" title="一.本文需要基本知识点"></a>一.本文需要基本知识点</h2><h3 id="C语言相关函数："><a href="#C语言相关函数：" class="headerlink" title="C语言相关函数："></a>C语言相关函数：</h3><p>1.memset：<br>原型： void    <em>memset(void </em><strong>b, int </strong>c, size_t __len);<br>解释：将s中当前位置后面的n个字节(typedef unsigned int size_t) 用ch替换并返回s<br>作用：在一段内存块中填充某个特定的值，它是对较大的结构体或数组进行清零操作的一种最快方法。</p>
<p>2.memcpy：<br>原型： void <em>memcpy(void </em>dest, const void *src, size_t n);<br>解释：从源src所指的内存地址的起始位置开始拷贝n个字节到目标dest所指的内存地址的起始位置中</p>
<h3 id="OC-中部分知识点："><a href="#OC-中部分知识点：" class="headerlink" title="OC 中部分知识点："></a>OC 中部分知识点：</h3><p>1.OSStaus:状态码，如果没有错误返回0：（即noErr）</p>
<p>2.AudioFormatGetPropertyInfo：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">原型： </div><div class="line">AudioFormatGetPropertyInfo(</div><div class="line">					    	AudioFormatPropertyID   inPropertyID,</div><div class="line">							<span class="built_in">UInt32</span>                  inSpecifierSize,</div><div class="line">		 					<span class="keyword">const</span> <span class="keyword">void</span> * __<span class="keyword">nullable</span> inSpecifier,</div><div class="line">							<span class="built_in">UInt32</span> *                outPropertyDataSize);</div><div class="line">									</div><div class="line">* 作用：检索给定属性的信息，比如编码器目标格式的size等</div></pre></td></tr></table></figure>
<p>3.AudioSessionGetProperty：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">原型： </div><div class="line"><span class="function"><span class="keyword">extern</span> OSStatus</span></div><div class="line"><span class="title">AudioSessionGetProperty</span><span class="params">(    </span></div><div class="line">							 	AudioSessionPropertyID     inID,</div><div class="line">		            			UInt32                     *ioDataSize,</div><div class="line">								<span class="keyword">void</span>                       *outData);</div><div class="line">									</div><div class="line">* 作用：获取指定AudioSession对象的inID属性的值（比如采样率，声道数等等）</div></pre></td></tr></table></figure>
<h3 id="音频基础知识"><a href="#音频基础知识" class="headerlink" title="音频基础知识"></a>音频基础知识</h3><ol>
<li><p>AVFoundation框架中的AVAudioPlayer和AVAudioRecorder类，用法简单，但是不支持流式，也就意味着在播放音频前，必须等到整个音频加载完成后，才能开始播放音频；录音时，也必须等到录音结束后才能获得录音数据。</p>
</li>
<li><p>在iOS和Mac OS X中，音频队列Audio Queues是一个用来录制和播放音频的软件对象，也就是说，可以用来录音和播放，录音能够获取实时的PCM原始音频数据。</p>
</li>
<li><p>数据介绍</p>
</li>
</ol>
<p>（1）In CBR (constant bit rate) formats, such as linear PCM and IMA/ADPCM, all packets are the same size.</p>
<p>（2）In VBR (variable bit rate) formats, such as AAC, Apple Lossless, and MP3, all packets have the same number of frames but the number of bits in each sample value can vary.</p>
<p>（3）In VFR (variable frame rate) formats, packets have a varying number of frames. There are no commonly used formats of this type.</p>
<ol>
<li>概念：</li>
</ol>
<p>(1)音频文件的组成：文件格式（或者音频容器）+数据格式（或者音频编码）</p>
<blockquote>
<p>知识点：</p>
</blockquote>
<ul>
<li>文件格式是用于形容文件本身的格式，可以通过多种不同方法为真正的音频数据编码，例如CAF文件便是一种文件格式，它能够包含MP3格式，线性PCM以及其他数据格式音频<br>线性PCM:这是表示线性脉冲编码机制，主要是描写用于将模拟声音数据转换成数组格式的技术，简单地说也就是未压缩的数据。因为数据是未压缩的，所以我们便可以最快速地播放出音频，而如果空间不是问题的话这便是iPhone 音频的优先代码选择      </li>
</ul>
<p>(2).音频文件计算大小<br>简述：声卡对声音的处理质量可以用三个基本参数来衡量，即采样频率，采样位数和声道数。</p>
<blockquote>
<p>知识点：</p>
</blockquote>
<ul>
<li><p>采样频率：单位时间内采样次数。采样频率越大，采样点之间的间隔就越小，数字化后得到的声音就越逼真，但相应的数据量就越大，声卡一般提供11.025kHz,22.05kHz和44.1kHz等不同的采样频率。</p>
</li>
<li><p>采样位数：记录每次采样值数值大小的位数。采样位数通常有8bits或16bits两种，采样位数越大，所能记录的声音变化度就越细腻，相应的数据量就越大。</p>
</li>
<li><p>声道数：处理的声音是单声道还是立体声。单声道在声音处理过程中只有单数据流，而立体声则需要左右声道的两个数据流。显然，立体声的效果要好，但相应数据量要比单声道数据量加倍。</p>
</li>
<li><p>声音数据量的计算公式：数据量（字节 / 秒）=（采样频率（Hz）<em> 采样位数（bit）</em> 声道数）/  8<br>单声道的声道数为1，立体声的声道数为2. 字节B，1MB=1024KB = 1024*1024B</p>
</li>
</ul>
<p>(3).音频队列 — 详细请参考 <a href="http://blog.csdn.net/jiangyiaxiu/article/details/9190035" target="_blank" rel="external">Audio Queue</a></p>
<h3 id="简述：在iOS和Mac-OS-X中，音频队列是一个用来录制和播放音频的软件对象，他用AudioQueueRef这个不透明数据类型来表示，该类型在AudioQueue-h头文件中声明。"><a href="#简述：在iOS和Mac-OS-X中，音频队列是一个用来录制和播放音频的软件对象，他用AudioQueueRef这个不透明数据类型来表示，该类型在AudioQueue-h头文件中声明。" class="headerlink" title="简述：在iOS和Mac OS X中，音频队列是一个用来录制和播放音频的软件对象，他用AudioQueueRef这个不透明数据类型来表示，该类型在AudioQueue.h头文件中声明。"></a>简述：在iOS和Mac OS X中，音频队列是一个用来录制和播放音频的软件对象，他用AudioQueueRef这个不透明数据类型来表示，该类型在AudioQueue.h头文件中声明。</h3><h3 id="工作："><a href="#工作：" class="headerlink" title="工作："></a>工作：</h3><ul>
<li>连接音频硬件</li>
<li>内存管理</li>
<li>根据需要为已压缩的音频格式引入编码器</li>
<li>媒体的录制或播放</li>
</ul>
<blockquote>
<p>你可以将音频队列配合其他Core Audio的接口使用，再加上相对少量的自定义代码就可以在你的应用程序中创建一套完整的数字音频录制或播放解决方案。</p>
</blockquote>
<h3 id="结构："><a href="#结构：" class="headerlink" title="结构："></a>结构：</h3><ul>
<li><p>一组音频队列缓冲区(audio queue buffers)，每个音频队列缓冲区都是一个存储音频数据的临时仓库</p>
</li>
<li><p>一个缓冲区队列(buffer queue)，一个包含音频队列缓冲区的有序列表</p>
</li>
<li><p>一个你自己编写的音频队列回调函数(audio queue callback)</p>
</li>
</ul>
<h4 id="它的架构很大程度上依赖于这个音频队列是用来录制还是用来播放的。不同之处在于音频队列如何连接到它的输入和输入，还有它的回调函数所扮演的角色。"><a href="#它的架构很大程度上依赖于这个音频队列是用来录制还是用来播放的。不同之处在于音频队列如何连接到它的输入和输入，还有它的回调函数所扮演的角色。" class="headerlink" title="它的架构很大程度上依赖于这个音频队列是用来录制还是用来播放的。不同之处在于音频队列如何连接到它的输入和输入，还有它的回调函数所扮演的角色。"></a>它的架构很大程度上依赖于这个音频队列是用来录制还是用来播放的。不同之处在于音频队列如何连接到它的输入和输入，还有它的回调函数所扮演的角色。</h4><h2 id="二-主要方法解析"><a href="#二-主要方法解析" class="headerlink" title="二.主要方法解析"></a>二.主要方法解析</h2><h3 id="1-设置AudioStreamBasicDescription-基本信息"><a href="#1-设置AudioStreamBasicDescription-基本信息" class="headerlink" title="1.设置AudioStreamBasicDescription 基本信息"></a>1.设置AudioStreamBasicDescription 基本信息</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">void</span>)startRecorderTest &#123;</div><div class="line">    <span class="comment">// save collect pcm data, 下面一行是本人采用单独设计的队列，大家可以自己定义一个队列存取</span></div><div class="line">    <span class="comment">// TVUSignaling::getInstance()-&gt;InitQueue(&amp;collectPcmQueue);</span></div><div class="line">    <span class="comment">// 用特定队列存取pcm的值，在这里初始化，可以采用不同方式进行存储，也可以自己定义一个队列，具体实现不做解释</span></div><div class="line">    </div><div class="line"><span class="comment">// 是否正在录制</span></div><div class="line">    <span class="keyword">if</span> (isRunning) &#123;</div><div class="line">        <span class="comment">// log4cplus_info("pcm", "Start recorder repeat");</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="comment">// 本例中采用log4打印log信息，若你没有可以不用，删除有关Log4的语句</span></div><div class="line">    <span class="comment">// log4cplus_info("pcm", "starup PCM audio encoder");</span></div><div class="line">    </div><div class="line"><span class="comment">// 设置采集的数据的类型为PCM</span></div><div class="line">    [<span class="keyword">self</span> setUpRecoderWithFormatID:kAudioFormatLinearPCM];</div><div class="line">    </div><div class="line"></div><div class="line">    OSStatus status          = <span class="number">0</span>;</div><div class="line">    <span class="built_in">UInt32</span>   size            = <span class="keyword">sizeof</span>(dataFormat);</div><div class="line">    </div><div class="line">    <span class="comment">// 编码器转码设置</span></div><div class="line">    [<span class="keyword">self</span> convertBasicSetting];</div><div class="line">    </div><div class="line">    <span class="comment">// 新建一个队列,第二个参数注册回调函数，第三个防止内存泄露</span></div><div class="line">    status =  AudioQueueNewInput(&amp;dataFormat, inputBufferHandler, (__bridge <span class="keyword">void</span> *)(<span class="keyword">self</span>), <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;mQueue);</div><div class="line">    <span class="comment">// log4cplus_info("pcm","AudioQueueNewInput status:%d",(int)status);</span></div><div class="line">    </div><div class="line"><span class="comment">// 获取队列属性</span></div><div class="line">    status = AudioQueueGetProperty(mQueue, kAudioQueueProperty_StreamDescription, &amp;dataFormat, &amp;size);</div><div class="line">    <span class="comment">// log4cplus_info("pcm","AudioQueueNewInput status:%u",(unsigned int)dataFormat.mFormatID);</span></div><div class="line">    </div><div class="line"><span class="comment">// 这里将头信息添加到写入文件中，若文件数据为CBR,不需要添加，为VBR需要添加</span></div><div class="line">    [<span class="keyword">self</span> copyEncoderCookieToFile];</div><div class="line">    </div><div class="line">    <span class="comment">//    可以计算获得，在这里使用的是固定大小</span></div><div class="line">    <span class="comment">//    bufferByteSize = [self computeRecordBufferSizeFrom:&amp;dataFormat andDuration:kBufferDurationSeconds];</span></div><div class="line">    </div><div class="line">    <span class="comment">// log4cplus_info("pcm","pcm raw data buff number:%d, channel number:%u",</span></div><div class="line">                   kNumberQueueBuffers,</div><div class="line">                   dataFormat.mChannelsPerFrame);</div><div class="line">    </div><div class="line"><span class="comment">// 设置三个音频队列缓冲区</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i != kNumberQueueBuffers; i++) &#123;</div><div class="line">	<span class="comment">// 注意：为每个缓冲区分配大小，由于这里将bufferSize写死所以需要和回调函数对应，否则会出错</span></div><div class="line">        status = AudioQueueAllocateBuffer(mQueue, <span class="number">1024</span>*<span class="number">2</span>*dataFormat.mChannelsPerFrame, &amp;mBuffers[i]);</div><div class="line">	<span class="comment">// 入队</span></div><div class="line">        status = AudioQueueEnqueueBuffer(mQueue, mBuffers[i], <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    isRunning  = <span class="literal">YES</span>;</div><div class="line">    hostTime   = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    status     =  AudioQueueStart(mQueue, <span class="literal">NULL</span>);</div><div class="line">    log4cplus_info(<span class="string">"pcm"</span>,<span class="string">"AudioQueueStart status:%d"</span>,(<span class="keyword">int</span>)status);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>初始化输出流的结构体描述</p>
</blockquote>
 <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> AudioStreamBasicDescription</div><div class="line">&#123;</div><div class="line">    Float64          	mSampleRate;	    <span class="comment">// 采样率 ：Hz</span></div><div class="line">    AudioFormatID      	mFormatID;	        <span class="comment">// 采样数据的类型，PCM,AAC等</span></div><div class="line">    AudioFormatFlags    mFormatFlags;	    <span class="comment">// 每种格式特定的标志，无损编码 ，0表示没有</span></div><div class="line">    <span class="built_in">UInt32</span>            	mBytesPerPacket;    <span class="comment">// 一个数据包中的字节数</span></div><div class="line">    <span class="built_in">UInt32</span>              mFramesPerPacket;   <span class="comment">// 一个数据包中的帧数，每个packet的帧数。如果是未压缩的音频数据，值是1。动态帧率格式，这个值是一个较大的固定数字，比如说AAC的1024。如果是动态大小帧数（比如Ogg格式）设置为0。</span></div><div class="line">    <span class="built_in">UInt32</span>            	mBytesPerFrame;     <span class="comment">// 每一帧中的字节数</span></div><div class="line">    <span class="built_in">UInt32</span>            	mChannelsPerFrame;  <span class="comment">// 每一帧数据中的通道数，单声道为1，立体声为2</span></div><div class="line">    <span class="built_in">UInt32</span>              mBitsPerChannel;    <span class="comment">// 每个通道中的位数，1byte = 8bit</span></div><div class="line">    <span class="built_in">UInt32</span>              mReserved; 		    <span class="comment">// 8字节对齐，填0</span></div><div class="line">&#125;;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> AudioStreamBasicDescription  AudioStreamBasicDescription;</div></pre></td></tr></table></figure>
<p>注意： kNumberQueueBuffers，音频队列可以使用任意数量的缓冲区。你的应用程序制定它的数量。一般情况下这个数字是3。这样就可以让给一个忙于将数据写入磁盘，同时另一个在填充新的音频数据，第三个缓冲区在需要做磁盘I/O延迟补偿的时候可用</p>
<blockquote>
<p>如何使用AudioQueue:</p>
</blockquote>
<ol>
<li>创建输入队列AudioQueueNewInput</li>
<li>分配buffers</li>
<li>入队：AudioQueueEnqueueBuffer</li>
<li>回调函数采集音频数据</li>
<li>出队</li>
</ol>
<blockquote>
<p>AudioQueueNewInput</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 作用：创建一个音频队列为了录制音频数据</span></div><div class="line">原型：<span class="keyword">extern</span> OSStatus             </div><div class="line">		AudioQueueNewInput( <span class="keyword">const</span> AudioStreamBasicDescription   *inFormat, 同上</div><div class="line">                            AudioQueueInputCallback             inCallbackProc, <span class="comment">// 注册回调函数</span></div><div class="line">                            <span class="keyword">void</span> * __<span class="keyword">nullable</span>               	inUserData,		</div><div class="line">                            <span class="built_in">CFRunLoopRef</span> __<span class="keyword">nullable</span>         	inCallbackRunLoop,</div><div class="line">                            <span class="built_in">CFStringRef</span> __<span class="keyword">nullable</span>          	inCallbackRunLoopMode,</div><div class="line">                            <span class="built_in">UInt32</span>                          	inFlags,</div><div class="line">                            AudioQueueRef __<span class="keyword">nullable</span>        	* __<span class="keyword">nonnull</span> outAQ)；</div><div class="line"></div><div class="line"><span class="comment">// 这个函数的第四个和第五个参数是有关于线程的，我设置成null，代表它默认使用内部线程去录音，而且还是异步的</span></div></pre></td></tr></table></figure>
<h3 id="2-设置采集数据的格式，采集PCM必须按照如下设置，参考苹果官方文档，不同需求自己另行修改"><a href="#2-设置采集数据的格式，采集PCM必须按照如下设置，参考苹果官方文档，不同需求自己另行修改" class="headerlink" title="2.设置采集数据的格式，采集PCM必须按照如下设置，参考苹果官方文档，不同需求自己另行修改"></a>2.设置采集数据的格式，采集PCM必须按照如下设置，参考苹果官方文档，不同需求自己另行修改</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"> -(<span class="keyword">void</span>)setUpRecoderWithFormatID:(UInt32)formatID &#123;</div><div class="line"></div><div class="line">    <span class="comment">//setup auido sample rate, channel number, and format ID</span></div><div class="line">    memset(&amp;dataFormat, <span class="number">0</span>, <span class="keyword">sizeof</span>(dataFormat));</div><div class="line">    </div><div class="line">    UInt32 <span class="built_in">size</span> = <span class="keyword">sizeof</span>(dataFormat.mSampleRate);</div><div class="line">    AudioSessionGetProperty(kAudioSessionProperty_CurrentHardwareSampleRate,</div><div class="line">                            &amp;<span class="built_in">size</span>,</div><div class="line">                            &amp;dataFormat.mSampleRate);</div><div class="line">    dataFormat.mSampleRate = <span class="number">44100.0</span>;	<span class="comment">// 设置采样率</span></div><div class="line">    </div><div class="line">    <span class="built_in">size</span> = <span class="keyword">sizeof</span>(dataFormat.mChannelsPerFrame);</div><div class="line">    AudioSessionGetProperty(kAudioSessionProperty_CurrentHardwareInputNumberChannels,</div><div class="line">                            &amp;<span class="built_in">size</span>,</div><div class="line">                            &amp;dataFormat.mChannelsPerFrame);</div><div class="line">    dataFormat.mFormatID = formatID;</div><div class="line">    </div><div class="line">    <span class="built_in">if</span> (formatID == kAudioFormatLinearPCM)</div><div class="line">    &#123;</div><div class="line">    	 <span class="comment">/*</span></div><div class="line">    	  为保存音频数据的方式的说明，如可以根据大端字节序或小端字节序，</div><div class="line">    	  浮点数或整数以及不同体位去保存数据</div><div class="line">          例如对PCM格式通常我们如下设置：kAudioFormatFlagIsSignedInteger | kAudioFormatFlagIsPacked等</div><div class="line">          */</div><div class="line">        dataFormat.mFormatFlags     = kLinearPCMFormatFlagIsSignedInteger | kLinearPCMFormatFlagIsPacked;</div><div class="line">        <span class="comment">// 每个通道里，一帧采集的bit数目</span></div><div class="line">        dataFormat.mBitsPerChannel  = <span class="number">16</span>;</div><div class="line">        <span class="comment">// 8bit为1byte，即为1个通道里1帧需要采集2byte数据，再*通道数，即为所有通道采集的byte数目</span></div><div class="line">        dataFormat.mBytesPerPacket  = dataFormat.mBytesPerFrame = (dataFormat.mBitsPerChannel / <span class="number">8</span>) * dataFormat.mChannelsPerFrame;</div><div class="line">        <span class="comment">// 每个包中的帧数</span></div><div class="line">        dataFormat.mFramesPerPacket = <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-将PCM转成AAC一些基本设置"><a href="#3-将PCM转成AAC一些基本设置" class="headerlink" title="3.将PCM转成AAC一些基本设置"></a>3.将PCM转成AAC一些基本设置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">void</span>)convertBasicSetting &#123;</div><div class="line">    </div><div class="line">    AudioStreamBasicDescription sourceDes = dataFormat; <span class="comment">// 原始格式</span></div><div class="line">    AudioStreamBasicDescription targetDes;              <span class="comment">// 转码后格式</span></div><div class="line">    </div><div class="line">    <span class="comment">// 设置目标格式及基本信息</span></div><div class="line">    <span class="built_in">memset</span>(&amp;targetDes, <span class="number">0</span>, <span class="keyword">sizeof</span>(targetDes));</div><div class="line">    targetDes.mFormatID           = kAudioFormatMPEG4AAC;</div><div class="line">    targetDes.mSampleRate         = <span class="number">44100.0</span>;</div><div class="line">    targetDes.mChannelsPerFrame   = dataFormat.mChannelsPerFrame;</div><div class="line">    </div><div class="line">    OSStatus status     = <span class="number">0</span>;</div><div class="line">    UInt32 targetSize   = <span class="keyword">sizeof</span>(targetDes);</div><div class="line">    status              = AudioFormatGetProperty(kAudioFormatProperty_FormatInfo, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;targetSize, &amp;targetDes);</div><div class="line">    <span class="comment">// log4cplus_info("pcm", "create target data format status:%d",(int)status);</span></div><div class="line">	</div><div class="line">    <span class="built_in">memset</span>(&amp;_targetDes, <span class="number">0</span>, <span class="keyword">sizeof</span>(_targetDes));</div><div class="line">    <span class="comment">// 赋给全局变量</span></div><div class="line">    <span class="built_in">memcpy</span>(&amp;_targetDes, &amp;targetDes, targetSize);</div><div class="line">    </div><div class="line">    <span class="comment">// 选择软件编码</span></div><div class="line">    AudioClassDescription audioClassDes;</div><div class="line">    status = AudioFormatGetPropertyInfo(kAudioFormatProperty_Encoders,</div><div class="line">                                        <span class="keyword">sizeof</span>(targetDes.mFormatID),</div><div class="line">                                        &amp;targetDes.mFormatID,</div><div class="line">                                        &amp;targetSize);</div><div class="line">    <span class="comment">// log4cplus_info("pcm","get kAudioFormatProperty_Encoders status:%d",(int)status);</span></div><div class="line">    </div><div class="line">    <span class="comment">// 计算编码器容量</span></div><div class="line">    UInt32 numEncoders = targetSize/<span class="keyword">sizeof</span>(AudioClassDescription);</div><div class="line">    <span class="comment">// 用数组存放编码器内容</span></div><div class="line">    AudioClassDescription audioClassArr[numEncoders];</div><div class="line">	<span class="comment">// 将编码器属性赋给数组</span></div><div class="line">    AudioFormatGetProperty(kAudioFormatProperty_Encoders,</div><div class="line">                           <span class="keyword">sizeof</span>(targetDes.mFormatID),</div><div class="line">                           &amp;targetDes.mFormatID,</div><div class="line">                           &amp;targetSize,</div><div class="line">                           audioClassArr);</div><div class="line">    <span class="comment">// log4cplus_info("pcm","wrirte audioClassArr status:%d",(int)status);</span></div><div class="line">    </div><div class="line"> <span class="comment">// 遍历数组，设置软编</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numEncoders; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (audioClassArr[i].mSubType == kAudioFormatMPEG4AAC &amp;&amp; audioClassArr[i].mManufacturer == kAppleSoftwareAudioCodecManufacturer) &#123;</div><div class="line">            <span class="built_in">memcpy</span>(&amp;audioClassDes, &amp;audioClassArr[i], <span class="keyword">sizeof</span>(AudioClassDescription));</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 新建一个编码对象，设置原，目标格式</span></div><div class="line">    status          = AudioConverterNewSpecific(&amp;sourceDes, &amp;targetDes, <span class="number">1</span>,</div><div class="line">                                                &amp;audioClassDes, &amp;_encodeConvertRef);</div><div class="line">    <span class="comment">// log4cplus_info("pcm","new convertRef status:%d",(int)status);</span></div><div class="line">    </div><div class="line"><span class="comment">// 获取原始格式大小</span></div><div class="line">    targetSize      = <span class="keyword">sizeof</span>(sourceDes);</div><div class="line">    status          = AudioConverterGetProperty(_encodeConvertRef, kAudioConverterCurrentInputStreamDescription, &amp;targetSize, &amp;sourceDes);</div><div class="line">    <span class="comment">// log4cplus_info("pcm","get sourceDes status:%d",(int)status);</span></div><div class="line">    </div><div class="line"><span class="comment">// 获取目标格式大小</span></div><div class="line">    targetSize      = <span class="keyword">sizeof</span>(targetDes);</div><div class="line">    status          = AudioConverterGetProperty(_encodeConvertRef, kAudioConverterCurrentOutputStreamDescription, &amp;targetSize, &amp;targetDes);;</div><div class="line">    <span class="comment">// log4cplus_info("pcm","get targetDes status:%d",(int)status);</span></div><div class="line">    </div><div class="line">    <span class="comment">// 设置码率，需要和采样率对应</span></div><div class="line">    UInt32 bitRate  = <span class="number">64000</span>;</div><div class="line">    targetSize      = <span class="keyword">sizeof</span>(bitRate);</div><div class="line">    status          = AudioConverterSetProperty(_encodeConvertRef,</div><div class="line">                                                kAudioConverterEncodeBitRate,</div><div class="line">                                                targetSize, &amp;bitRate);</div><div class="line">    <span class="comment">// log4cplus_info("pcm","set covert property bit rate status:%d",(int)status);</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>AudioFormatGetProperty：</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">原型： </div><div class="line"><span class="keyword">extern</span> OSStatus</div><div class="line">	 </div><div class="line">AudioFormatGetProperty(	AudioFormatPropertyID    inPropertyID,</div><div class="line">							<span class="built_in">UInt32</span>				        inSpecifierSize,</div><div class="line">							<span class="keyword">const</span> <span class="keyword">void</span> * __<span class="keyword">nullable</span>  inSpecifier,</div><div class="line">							<span class="built_in">UInt32</span> 	 * __<span class="keyword">nullable</span>  ioPropertyDataSize,</div><div class="line">							<span class="keyword">void</span> * __nullabl         outPropertyData);</div><div class="line">作用：检索某个属性的值</div></pre></td></tr></table></figure>
<blockquote>
<p>AudioClassDescription：</p>
</blockquote>
<p>指的是一个能够对一个信号或者一个数据流进行变换的设备或者程序。这里指的变换既包括将 信号或者数据流进行编码（通常是为了传输、存储或者加密）或者提取得到一个编码流的操作，也包括为了观察或者处理从这个编码流中恢复适合观察或操作的形式的操作。编解码器经常用在视频会议和流媒体等应用中。</p>
<p>默认情况下，Apple会创建一个硬件编码器，如果硬件不可用，会创建软件编码器。</p>
<p>经过我的测试，硬件AAC编码器的编码时延很高，需要buffer大约2秒的数据才会开始编码。而软件编码器的编码时延就是正常的，只要喂给1024个样点，就会开始编码。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">AudioConverterNewSpecific：</div><div class="line">原型： <span class="keyword">extern</span> OSStatus</div><div class="line">AudioConverterNewSpecific(  <span class="keyword">const</span> AudioStreamBasicDescription * inSourceFormat,</div><div class="line">                            <span class="keyword">const</span> AudioStreamBasicDescription * inDestinationFormat,</div><div class="line">                            <span class="built_in">UInt32</span>                              inNumberClassDescriptions,</div><div class="line">                            <span class="keyword">const</span> AudioClassDescription *       inClassDescriptions,</div><div class="line">                            AudioConverterRef __<span class="keyword">nullable</span> * __<span class="keyword">nonnull</span> outAudioConverter)；</div><div class="line">      </div><div class="line">解释：创建一个转换器</div><div class="line">作用：设置一些转码基本信息</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">AudioConverterSetProperty：</div><div class="line">原型：extern OSStatus </div><div class="line">AudioConverterSetProperty(  AudioConverterRef           <span class="keyword">in</span>AudioConverter,</div><div class="line">                            AudioConverterPropertyID    <span class="keyword">in</span>PropertyID,</div><div class="line">                            UInt32                      <span class="keyword">in</span>PropertyDataSize,</div><div class="line">                            const void *                <span class="keyword">in</span>PropertyData)；</div><div class="line">作用：设置码率，需要注意，AAC并不是随便的码率都可以支持。比如如果PCM采样率是44100KHz，那么码率可以设置64000bps，如果是16K，可以设置为32000bps。</div></pre></td></tr></table></figure>
<h3 id="4-设置最终音频文件的头部信息-此类写法为将pcm转为AAC的写法"><a href="#4-设置最终音频文件的头部信息-此类写法为将pcm转为AAC的写法" class="headerlink" title="4.设置最终音频文件的头部信息(此类写法为将pcm转为AAC的写法)"></a>4.设置最终音频文件的头部信息(此类写法为将pcm转为AAC的写法)</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">void</span>)copyEncoderCookieToFile</div><div class="line">&#123;</div><div class="line">    <span class="comment">// Grab the cookie from the converter and write it to the destination file.</span></div><div class="line">    UInt32 cookieSize = <span class="number">0</span>;</div><div class="line">    OSStatus error = AudioConverterGetPropertyInfo(_encodeConvertRef, kAudioConverterCompressionMagicCookie, &amp;cookieSize, <span class="literal">NULL</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// If there is an error here, then the format doesn't have a cookie - this is perfectly fine as som formats do not.</span></div><div class="line">    <span class="comment">// log4cplus_info("cookie","cookie status:%d %d",(int)error, cookieSize);</span></div><div class="line">    <span class="keyword">if</span> (error == noErr &amp;&amp; cookieSize != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">char</span> *cookie = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(cookieSize * <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</div><div class="line">        <span class="comment">//        UInt32 *cookie = (UInt32 *)malloc(cookieSize * sizeof(UInt32));</span></div><div class="line">        error = AudioConverterGetProperty(_encodeConvertRef, kAudioConverterCompressionMagicCookie, &amp;cookieSize, cookie);</div><div class="line">        <span class="comment">// log4cplus_info("cookie","cookie size status:%d",(int)error);</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (error == noErr) &#123;</div><div class="line">            error = AudioFileSetProperty(mRecordFile, kAudioFilePropertyMagicCookieData, cookieSize, cookie);</div><div class="line">            <span class="comment">// log4cplus_info("cookie","set cookie status:%d ",(int)error);</span></div><div class="line">            <span class="keyword">if</span> (error == noErr) &#123;</div><div class="line">                UInt32 willEatTheCookie = <span class="literal">false</span>;</div><div class="line">                error = AudioFileGetPropertyInfo(mRecordFile, kAudioFilePropertyMagicCookieData, <span class="literal">NULL</span>, &amp;willEatTheCookie);</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"Writing magic cookie to destination file: %u\n   cookie:%d \n"</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)cookieSize, willEatTheCookie);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"Even though some formats have cookies, some files don't take them and that's OK\n"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"Could not Get kAudioConverterCompressionMagicCookie from Audio Converter!\n"</span>);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="built_in">free</span>(cookie);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Magic cookie 是一种不透明的数据格式，它和压缩数据文件与流联系密切，如果文件数据为CBR格式（无损），则不需要添加头部信息，如果为VBR需要添加</p>
</blockquote>
<h3 id="5-AudioQueue中注册的回调函数"><a href="#5-AudioQueue中注册的回调函数" class="headerlink" title="5.AudioQueue中注册的回调函数"></a>5.AudioQueue中注册的回调函数</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AudioQueue中注册的回调函数</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">inputBufferHandler</span><span class="params">(<span class="keyword">void</span> *                                 inUserData,</span></span></div><div class="line">                               AudioQueueRef                          inAQ,</div><div class="line">                               AudioQueueBufferRef                    inBuffer,</div><div class="line">                               <span class="keyword">const</span> AudioTimeStamp *                 inStartTime,</div><div class="line">                               UInt32                                 inNumPackets,</div><div class="line">                               <span class="keyword">const</span> AudioStreamPacketDescription*	  inPacketDesc) &#123;</div><div class="line">    <span class="comment">// 相当于本类对象实例</span></div><div class="line">    TVURecorder *recoder        = (TVURecorder *)inUserData;</div><div class="line">    </div><div class="line">    <span class="comment">// collect pcm data，可以使用不用方式在此存储pcm原始数据</span></div><div class="line">    TVUSignaling::getInstance()-&gt;EnQueue(&amp;collectPcmQueue, (<span class="keyword">const</span> <span class="keyword">char</span>*)inBuffer-&gt;mAudioData, inBuffer-&gt;mAudioDataByteSize, KSignalingTypeLogin);</div><div class="line">    </div><div class="line"><span class="comment">// inNumPackets设置为1表示编码产生1帧数据即返回</span></div><div class="line">    inNumPackets                = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="comment">// 将PCM数据转换为AAC</span></div><div class="line">    AudioBufferList *bufferList = convertPCMToAAC(inBuffer, recoder, inNumPackets);</div><div class="line">    <span class="comment">// 释放内存</span></div><div class="line">    <span class="built_in">free</span>(bufferList);</div><div class="line">    <span class="comment">//begin write audio data for record audio only</span></div><div class="line">    </div><div class="line">    <span class="comment">// 出队</span></div><div class="line">    AudioQueueRef <span class="built_in">queue</span> = recoder.mQueue;</div><div class="line">    <span class="keyword">if</span> (recoder.isRunning) &#123;</div><div class="line">        AudioQueueEnqueueBuffer(<span class="built_in">queue</span>, inBuffer, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>解析回调函数：相当于中断服务函数，每次录取到音频数据就进入这个函数  </p>
</blockquote>
<ul>
<li>inAQ 是调用回调函数的音频队列  </li>
<li>inBuffer 是一个被音频队列填充新的音频数据的音频队列缓冲区，它包含了回调函数写入文件所需要的新数据  </li>
<li>inStartTime 是缓冲区中的一采样的参考时间，对于基本的录制，你的毁掉函数不会使用这个参数  </li>
<li>inNumPackets是inPacketDescs参数中包描述符（packet descriptions）的数量，如果你正在录制一个VBR(可变比特率（variable bitrate））格式, 音频队列将会提供这个参数给你的回调函数，这个参数可以让你传递给AudioFileWritePackets函数. CBR (常量比特率（constant bitrate）) 格式不使用包描述符。对于CBR录制，音频队列会设置这个参数并且将inPacketDescs这个参数设置为NULL，官方解释为The number of packets of audio data sent to the callback in the inBuffer parameter.</li>
</ul>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// PCM -&gt; AAC</span></div><div class="line">AudioBufferList* convertPCMToAAC (AudioQueueBufferRef inBuffer, TVURecorder *recoder, UInt32 inNumPackets) &#123;</div><div class="line">    </div><div class="line">    UInt32   maxPacketSize    = <span class="number">0</span>;</div><div class="line">    UInt32   size             = sizeof(maxPacketSize);</div><div class="line">    OSStatus status;</div><div class="line">    </div><div class="line">	<span class="comment">// 获取转换器最大输出包的大小</span></div><div class="line">    status = AudioConverterGetProperty(_encodeConvertRef,</div><div class="line">                                       kAudioConverterPropertyMaximumOutputPacketSize,</div><div class="line">                                       &amp;size,</div><div class="line">                                       &amp;maxPacketSize);</div><div class="line">    <span class="comment">// log4cplus_info("AudioConverter","kAudioConverterPropertyMaximumOutputPacketSize status:%d \n",(int)status);</span></div><div class="line">    </div><div class="line"><span class="comment">// 初始化一个bufferList存储数据</span></div><div class="line">    AudioBufferList *bufferList             = (AudioBufferList *)malloc(sizeof(AudioBufferList));</div><div class="line">    <span class="function"><span class="title">bufferList</span>-&gt;</span>mNumberBuffers              = <span class="number">1</span>;</div><div class="line">    <span class="function"><span class="title">bufferList</span>-&gt;</span>mBuffers[<span class="number">0</span>].mNumberChannels = _targetDes.mChannelsPerFrame;</div><div class="line">    <span class="function"><span class="title">bufferList</span>-&gt;</span>mBuffers[<span class="number">0</span>].mData           = malloc(maxPacketSize);</div><div class="line">    <span class="function"><span class="title">bufferList</span>-&gt;</span><span class="function"><span class="title">mBuffers</span>[0].mDataByteSize   = inBuffer-&gt;</span>mAudioDataByteSize;</div><div class="line"></div><div class="line">    AudioStreamPacketDescription outputPacketDescriptions;</div><div class="line">    </div><div class="line">    <span class="comment">// inNumPackets设置为1表示编码产生1帧数据即返回</span></div><div class="line">    status = AudioConverterFillComplexBuffer(_encodeConvertRef,</div><div class="line">                                             encodeConverterComplexInputDataProc,	<span class="comment">// 填充数据的回调函数</span></div><div class="line">                                             <span class="function"><span class="title">inBuffer</span>-&gt;</span>mAudioData,		<span class="comment">// 音频队列缓冲区中数据</span></div><div class="line">                                             &amp;inNumPackets,		</div><div class="line">                                             bufferList,			<span class="comment">// 成功后将值赋给bufferList</span></div><div class="line">                                             &amp;outputPacketDescriptions);	<span class="comment">// 输出包包含的一些信息</span></div><div class="line">    log4cplus_info(<span class="string">"AudioConverter"</span>,<span class="string">"set AudioConverterFillComplexBuffer status:%d"</span>,(int)status);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (recoder.needsVoiceDemo)</div><div class="line">    &#123;</div><div class="line">	<span class="comment">// 将AAC数据写入文件</span></div><div class="line">        OSStatus status = AudioFileWritePackets(recoder.mRecordFile,</div><div class="line">                                                FALSE,</div><div class="line">                                                <span class="function"><span class="title">bufferList</span>-&gt;</span>mBuffers[<span class="number">0</span>].mDataByteSize,</div><div class="line">                                                &amp;outputPacketDescriptions,</div><div class="line">                                                recoder.mRecordPacket,</div><div class="line">                                                &amp;inNumPackets,</div><div class="line">                                                <span class="function"><span class="title">bufferList</span>-&gt;</span>mBuffers[<span class="number">0</span>].mData);</div><div class="line">        <span class="comment">// log4cplus_info("write file","write file status = %d",(int)status);</span></div><div class="line">        recoder.mRecordPacket += inNumPackets;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return bufferList;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>解析</p>
</blockquote>
<p> outputPacketDescriptions数组是每次转换的AAC编码后各个包的描述,但这里每次只转换一包数据(由传入的packetSize决定)。调用AudioConverterFillComplexBuffer触发转码，他的第二个参数是填充原始音频数据的回调。转码完成后，会将转码的数据存放在它的第五个参数中(bufferList).</p>
<h3 id="总结：第一次接触音频类程序底层的处理，首先看了很多相关博客，简书，然后manager让我通读CoreAudio官方文档，感觉受益颇大，很多优秀的文章都是把苹果官方文档Core-Audio内容翻译，包括苹果给的图都很形象，建议有时间的朋友可以通读一下，每个人的需求不同，做的过程中遇到的问题肯定不同，只有理解了每个参数的含义才能灵活的控制代码，希望可以帮到大家，喜欢的可以转载。"><a href="#总结：第一次接触音频类程序底层的处理，首先看了很多相关博客，简书，然后manager让我通读CoreAudio官方文档，感觉受益颇大，很多优秀的文章都是把苹果官方文档Core-Audio内容翻译，包括苹果给的图都很形象，建议有时间的朋友可以通读一下，每个人的需求不同，做的过程中遇到的问题肯定不同，只有理解了每个参数的含义才能灵活的控制代码，希望可以帮到大家，喜欢的可以转载。" class="headerlink" title="总结：第一次接触音频类程序底层的处理，首先看了很多相关博客，简书，然后manager让我通读CoreAudio官方文档，感觉受益颇大，很多优秀的文章都是把苹果官方文档Core Audio内容翻译，包括苹果给的图都很形象，建议有时间的朋友可以通读一下，每个人的需求不同，做的过程中遇到的问题肯定不同，只有理解了每个参数的含义才能灵活的控制代码，希望可以帮到大家，喜欢的可以转载。"></a>总结：第一次接触音频类程序底层的处理，首先看了很多相关博客，简书，然后manager让我通读CoreAudio官方文档，感觉受益颇大，很多优秀的文章都是把苹果官方文档<a href="https://developer.apple.com/library/content/documentation/MusicAudio/Conceptual/CoreAudioOverview/CoreAudioEssentials/CoreAudioEssentials.html" target="_blank" rel="external">Core Audio</a>内容翻译，包括苹果给的图都很形象，建议有时间的朋友可以通读一下，每个人的需求不同，做的过程中遇到的问题肯定不同，只有理解了每个参数的含义才能灵活的控制代码，希望可以帮到大家，喜欢的可以转载。</h3>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2017/03/24/record/">Audio -- PCM to AAC</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 小东邪_Chengyang 的个人博客">小东邪_Chengyang</a></p>
        <p><span>发布时间:</span>2017年03月24日 - 15时36分</p>
        <p><span>最后更新:</span>2017年03月24日 - 17时53分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2017/03/24/record/" title="Audio -- PCM to AAC">http://yoursite.com/2017/03/24/record/</a>
            <span class="copy-path" data-clipboard-text="原文: http://yoursite.com/2017/03/24/record/　　作者: 小东邪_Chengyang" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
  
    <a href="/2017/03/24/audio/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title"></div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#本例需求：将Mic采集的PCM转成AAC，可得到两种不同数据-本例采用AudioQueue存储"><span class="toc-number">1.</span> <span class="toc-text">本例需求：将Mic采集的PCM转成AAC，可得到两种不同数据,本例采用AudioQueue存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#原理：由于需求更改为Mic采集的pcm一路提供给WebRTC使用，另一路将pcm转为aac，将aac提供给直播用的API。因此应该先让Mic采集原始pcm数据，采用队列保存，然后在回调函数中将其转换为aac提供给C-API"><span class="toc-number">2.</span> <span class="toc-text">原理：由于需求更改为Mic采集的pcm一路提供给WebRTC使用，另一路将pcm转为aac，将aac提供给直播用的API。因此应该先让Mic采集原始pcm数据，采用队列保存，然后在回调函数中将其转换为aac提供给C++API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一-本文需要基本知识点"><span class="toc-number"></span> <span class="toc-text">一.本文需要基本知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#C语言相关函数："><span class="toc-number">1.</span> <span class="toc-text">C语言相关函数：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OC-中部分知识点："><span class="toc-number">2.</span> <span class="toc-text">OC 中部分知识点：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#音频基础知识"><span class="toc-number">3.</span> <span class="toc-text">音频基础知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#简述：在iOS和Mac-OS-X中，音频队列是一个用来录制和播放音频的软件对象，他用AudioQueueRef这个不透明数据类型来表示，该类型在AudioQueue-h头文件中声明。"><span class="toc-number">4.</span> <span class="toc-text">简述：在iOS和Mac OS X中，音频队列是一个用来录制和播放音频的软件对象，他用AudioQueueRef这个不透明数据类型来表示，该类型在AudioQueue.h头文件中声明。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#工作："><span class="toc-number">5.</span> <span class="toc-text">工作：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#结构："><span class="toc-number">6.</span> <span class="toc-text">结构：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#它的架构很大程度上依赖于这个音频队列是用来录制还是用来播放的。不同之处在于音频队列如何连接到它的输入和输入，还有它的回调函数所扮演的角色。"><span class="toc-number">6.1.</span> <span class="toc-text">它的架构很大程度上依赖于这个音频队列是用来录制还是用来播放的。不同之处在于音频队列如何连接到它的输入和输入，还有它的回调函数所扮演的角色。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二-主要方法解析"><span class="toc-number"></span> <span class="toc-text">二.主要方法解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-设置AudioStreamBasicDescription-基本信息"><span class="toc-number">1.</span> <span class="toc-text">1.设置AudioStreamBasicDescription 基本信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-设置采集数据的格式，采集PCM必须按照如下设置，参考苹果官方文档，不同需求自己另行修改"><span class="toc-number">2.</span> <span class="toc-text">2.设置采集数据的格式，采集PCM必须按照如下设置，参考苹果官方文档，不同需求自己另行修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-将PCM转成AAC一些基本设置"><span class="toc-number">3.</span> <span class="toc-text">3.将PCM转成AAC一些基本设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-设置最终音频文件的头部信息-此类写法为将pcm转为AAC的写法"><span class="toc-number">4.</span> <span class="toc-text">4.设置最终音频文件的头部信息(此类写法为将pcm转为AAC的写法)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-AudioQueue中注册的回调函数"><span class="toc-number">5.</span> <span class="toc-text">5.AudioQueue中注册的回调函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结：第一次接触音频类程序底层的处理，首先看了很多相关博客，简书，然后manager让我通读CoreAudio官方文档，感觉受益颇大，很多优秀的文章都是把苹果官方文档Core-Audio内容翻译，包括苹果给的图都很形象，建议有时间的朋友可以通读一下，每个人的需求不同，做的过程中遇到的问题肯定不同，只有理解了每个参数的含义才能灵活的控制代码，希望可以帮到大家，喜欢的可以转载。"><span class="toc-number">6.</span> <span class="toc-text">总结：第一次接触音频类程序底层的处理，首先看了很多相关博客，简书，然后manager让我通读CoreAudio官方文档，感觉受益颇大，很多优秀的文章都是把苹果官方文档Core Audio内容翻译，包括苹果给的图都很形象，建议有时间的朋友可以通读一下，每个人的需求不同，做的过程中遇到的问题肯定不同，只有理解了每个参数的含义才能灵活的控制代码，希望可以帮到大家，喜欢的可以转载。</span></a></li></ol>
</div>
<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
    }
</script>





<div class="bdsharebuttonbox">
	<a href="#" class="fx fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="fx fa-weixin bds_weixin" data-cmd="weixin" title="分享到微信"></a>
	<a href="#" class="fx fa-qq bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
	<a href="#" class="fx fa-facebook-official bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
	<a href="#" class="fx fa-twitter bds_twi" data-cmd="twi" title="分享到Twitter"></a>
	<a href="#" class="fx fa-linkedin bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
	<a href="#" class="fx fa-files-o bds_copy" data-cmd="copy" title="分享到复制网址"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>




    
      <div class="duoshuo" id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="2017/03/24/record/" data-title="Audio -- PCM to AAC" data-url="http://yoursite.com/2017/03/24/record/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"xiaodongxie"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = '/js/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    <!-- 多说公共JS代码 end -->
</div>

    



    <div class="scroll" id="post-nav-button">
        
            <a href="/" title="回到主页"><i class="fa fa-home"></i></a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2017/03/24/audio/" title="下一篇: ">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/03/24/record/">Audio -- PCM to AAC</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/24/audio/">audio</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/25/group/">代码隐藏GroupedTableView上边多余的间隔</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/25/sendValue/">iOS控制器之间传值</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/23/masonry/">iOS之Masonry快速上手</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/23/hello/">Hello 小东邪</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/09/fulltext/">iOS之富文本</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/25/java/">mac系统安装Apache Tomcat详细步骤</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/25/ios-help/">iOS帮助文档最新安装方法</a></li></ul>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
            }
        })
    </script>



    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2017 小东邪_Chengyang
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >桃花岛到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本模块阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 24;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>